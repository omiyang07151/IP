/*
Copyright 2014, KISSY v1.50
MIT Licensed
build time: Mar 13 17:47
*/
KISSY.add("combobox/combobox-xtpl",[],function(i,h,j,k){i=function(c,a,f){var g=this,d=a.escapeHtml,n=g.utils.callCommand,o=g.nativeCommands["if"],a='<div id="ks-combobox-invalid-el-',b=c.resolve(["id"]),a=a+d(b),a=a+'"\n     class="',b={},e=[];e.push("invalid-el");b.params=e;b=n(g,c,b,"getBaseCssClasses",2);a+=d(b);a+='">\n    <div class="';b={};e=[];e.push("invalid-inner");b.params=e;var b=n(g,c,b,"getBaseCssClasses",3),a=a+d(b),a=a+'"></div>\n</div>\n\n',b={},e=[],j=c.resolve(["hasTrigger"]);e.push(j);
b.params=e;b.fn=function(a){var b;b='\n<div id="ks-combobox-trigger-';var e=a.resolve(["id"]);b+=d(e);b+='"\n     class="';var e={},c=[];c.push("trigger");e.params=c;e=n(g,a,e,"getBaseCssClasses",8);b+=d(e);b+='">\n    <div class="';e={};c=[];c.push("trigger-inner");e.params=c;a=n(g,a,e,"getBaseCssClasses",9);b+=d(a);return b+'">&#x25BC;</div>\n</div>\n'};a+=o.call(g,c,b,f);a+='\n\n<div class="';b={};e=[];e.push("input-wrap");b.params=e;b=n(g,c,b,"getBaseCssClasses",13);a+=d(b);a+='">\n\n    <input id="ks-combobox-input-';
b=c.resolve(["id"]);a+=d(b);a+='"\n           aria-haspopup="true"\n           aria-autocomplete="list"\n           aria-haspopup="true"\n           role="autocomplete"\n           aria-expanded="false"\n\n    ';b={};e=[];j=c.resolve(["disabled"]);e.push(j);b.params=e;b.fn=function(){return"\n    disabled\n    "};a+=o.call(g,c,b,f);a+='\n\n    autocomplete="off"\n    class="';b={};e=[];e.push("input");b.params=e;b=n(g,c,b,"getBaseCssClasses",27);a+=d(b);a+='"\n\n    value="';b=c.resolve(["value"]);
a+=d(b);a+='"\n    />\n\n\n    <label id="ks-combobox-placeholder-';b=c.resolve(["id"]);a+=d(b);a+='"\n           for="ks-combobox-input-';b=c.resolve(["id"]);a+=d(b);a+="\"\n            style='display:";b={};e=[];j=c.resolve(["value"]);e.push(j);b.params=e;b.fn=function(){return"none"};b.inverse=function(){return"block"};a+=o.call(g,c,b,f);a+=";'\n    class=\"";f={};o=[];o.push("placeholder");f.params=o;f=n(g,c,f,"getBaseCssClasses",36);a+=d(f);a+='">\n    ';c=c.resolve(["placeholder"]);a+=d(c);
return a+"\n    </label>\n</div>\n"};i.TPL_NAME=k.name;return i});
KISSY.add("combobox/render",["component/control","./combobox-xtpl"],function(i,h){var j=h("component/control"),k=h("./combobox-xtpl");return j.getDefaultRender().extend({beforeCreateDom:function(c,a){i.mix(a,{input:"#ks-combobox-input-{id}",trigger:"#ks-combobox-trigger-{id}",invalidEl:"#ks-combobox-invalid-el-{id}",placeholderEl:"#ks-combobox-placeholder-{id}"})},getKeyEventTarget:function(){return this.control.get("input")},_onSetCollapsed:function(c){this.control.get("input").attr("aria-expanded",!c)},
_onSetDisabled:function(c,a){this.callSuper(c,a);this.control.get("input").attr("disabled",c)}},{ATTRS:{contentTpl:{value:k}},HTML_PARSER:{value:function(c){return c.one("."+this.getBaseCssClass("input")).val()},input:function(c){return c.one("."+this.getBaseCssClass("input"))},trigger:function(c){return c.one("."+this.getBaseCssClass("trigger"))},invalidEl:function(c){return c.one("."+this.getBaseCssClass("invalid-el"))},placeholderEl:function(c){return c.one("."+this.getBaseCssClass("placeholder"))}}})});
KISSY.add("combobox/control",["node","component/control","./render","menu"],function(i,h){function j(l){for(var a=0;a<l.length;a++)if(!l[a].get("disabled"))return l[a];return null}function k(){o(this)}function c(){var l=this;setTimeout(function(){b(l)},0)}function a(){this.focus();b(this)}function f(){this.setValueFromAutocomplete(this.getValueForAutocomplete(),{force:1})}function g(l){var b;b=this.get("menu");if(!l||b===l.target){var l=this.get("input"),d=b.get("el");b=b.get("contentEl");l.attr("aria-owns",
d.attr("id"));d.on("focusout",k,this);d.on("focusin",c,this);b.on("mouseover",a,this);b.on("mousedown",f,this)}}function d(l){l=l.target;l.isMenuItem&&(l=l.get("textContent"),this.setValueFromAutocomplete(l),this._savedValue=l,this.set("collapsed",!0))}function n(l,b){var a=l.$el,d=l.view.getBaseCssClasses("invalid"),e=l.get("invalidEl");b?(a.addClass(d),e.attr("title",b),e.show()):(a.removeClass(d),e.hide())}function o(b){b._focusoutDismissTimer||(b._focusoutDismissTimer=setTimeout(function(){b._focusoutDismissTimer&&
b.set("collapsed",!0)},50))}function b(b){var a=b._focusoutDismissTimer;a&&(clearTimeout(a),b._focusoutDismissTimer=null)}function e(b){this.set("value",b.target.value,{data:{causedByInputEvent:1}})}function s(b){var a,d=[],e,c,d=this.get("menu"),b=this.normalizeData(b);d.removeChildren(!0);(c=d.get("highlightedItem"))&&c.set("highlighted",!1);if(b&&b.length){for(c=0;c<b.length;c++)a=b[c],d.addChild(a);d=d.get("children");b=this.getValueForAutocomplete();if(this.get("highlightMatchItem"))for(c=0;c<
d.length;c++)if(d[c].get("textContent")===b){d[c].set("highlighted",!0);e=!0;break}if(!e&&this.get("autoHighlightFirst"))for(c=0;c<d.length;c++)if(!d[c].get("disabled")){d[c].set("highlighted",!0);break}this.set("collapsed",!1);this.fire("afterRenderData")}else this.set("collapsed",!0)}var t=h("node"),q=h("component/control"),p=h("./render");h("menu");var m=t.KeyCode;return q.extend([],{initializer:function(){this.publish("afterRenderData",{bubbles:!1})},_savedValue:null,normalizeData:function(b){var a,
d,c;if(b&&b.length){b=b.slice(0,this.get("maxItemCount"));a=this.get("format")?this.get("format").call(this,this.getValueForAutocomplete(),b):[];for(c=0;c<b.length;c++)d=b[c],a[c]=i.mix({content:d,textContent:d,value:d},a[c])}return a},bindUI:function(){this.get("input").on("input",e,this);this.on("click",d,this);var b=this.get("menu");if(b.get("rendered"))g.call(this);else b.on("afterRenderUI",g,this)},destructor:function(){this.get("menu").destroy()},getValueForAutocomplete:function(){return this.get("value")},
setValueFromAutocomplete:function(b,a){this.set("value",b,a)},_onSetValue:function(b,a){var d;a.causedByInputEvent?(d=this.getValueForAutocomplete(),void 0===d?this.set("collapsed",!0):(this._savedValue=d,this.sendRequest(d))):this.get("input").val(b)},handleFocusInternal:function(){var b;this.get("invalidEl")&&n(this,!1);(b=this.get("placeholderEl"))&&b.hide()},handleBlurInternal:function(b){var a=this,d=a.get("placeholderEl");a.callSuper(b);o(a);a.get("invalidEl")&&a.validate(function(b,d){b?!a.get("focused")&&
d===a.get("value")&&n(a,b):n(a,!1)});d&&!a.get("value")&&d.show()},handleMouseDownInternal:function(b){var a,d;this.callSuper(b);a=b.target;if((d=this.get("trigger"))&&(d[0]===a||d.contains(a)))this.get("collapsed")?(this.focus(),this.sendRequest("")):this.set("collapsed",!0),b.preventDefault()},handleKeyDownInternal:function(b){var a,d=b.keyCode,c,e,g=this.get("menu");this.get("input");a=this.get("updateInputOnDownUp");if(g.get("visible")){c=g.get("highlightedItem");if(a&&c&&(e=g.get("children"),
d===m.DOWN&&c===j(e.concat().reverse())||d===m.UP&&c===j(e)))return this.setValueFromAutocomplete(this._savedValue),c.set("highlighted",!1),!0;e=g.handleKeyDownInternal(b);c=g.get("highlightedItem");if(d===m.ESC)return this.set("collapsed",!0),a&&this.setValueFromAutocomplete(this._savedValue),!0;a&&i.inArray(d,[m.DOWN,m.UP])&&this.setValueFromAutocomplete(c.get("textContent"));return d===m.TAB&&c&&(c.handleClickInternal(b),this.get("multiple"))?!0:e}if(d===m.DOWN||d===m.UP)if(b=this.getValueForAutocomplete(),
void 0!==b)return this.sendRequest(b),!0},validate:function(b){var a=this.get("validator"),d=this.getValueForAutocomplete();a?a(d,function(a){b(a,d)}):b(!1,d)},sendRequest:function(b){this.get("dataSource").fetchData(b,s,this)},_onSetCollapsed:function(a){var d=this.$el,c=this.get("menu");a?c.hide():(b(this),c.get("visible")||(this.get("matchElWidth")&&(c.render(),a=c.get("el"),a=(parseInt(a.css("borderLeftWidth"),10)||0)+(parseInt(a.css("borderRightWidth"),10)||0),c.set("width",d[0].offsetWidth-
a)),c.show()))}},{ATTRS:{input:{},value:{value:"",sync:0,view:1},trigger:{},placeholder:{view:1},placeholderEl:{},validator:{},invalidEl:{},allowTextSelection:{value:!0},hasTrigger:{value:!0,view:1},menu:{value:{},getter:function(b){b.isControl||(b.xclass=b.xclass||"popupmenu",b=this.createComponent(b),this.setInternal("menu",b));return b},setter:function(b){if(b.isControl){b.setInternal("parent",this);var a={node:this.$el,points:["bl","tl"],overflow:{adjustX:1,adjustY:1}};i.mix(b.get("align"),a,
!1)}}},collapsed:{view:1,value:!0},dataSource:{},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},updateInputOnDownUp:{value:!0},autoHighlightFirst:{},highlightMatchItem:{value:!0},xrender:{value:p}},xclass:"combobox"})});
KISSY.add("combobox/cursor",["node"],function(i,h){function j(g){var d=a;d||(d=k(c));"textarea"===""+g[0].type.toLowerCase()?d.css("width",g.css("width")):d.css("width",9999);i.each(f,function(a){d.css(a,g.css(a))});a||d.insertBefore(g[0].ownerDocument.body.firstChild);return a=d}var k=h("node").all,c='<div style="z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;"></div>',a,f="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(",");
return function(a){var d=k(a),a=d[0],c=a.ownerDocument,f=k(c),b=a.scrollTop,e=a.scrollLeft;if(c.selection)return a=c.selection.createRange(),{left:a.boundingLeft+e+f.scrollLeft(),top:a.boundingTop+b+a.boundingHeight+f.scrollTop()};f=d.offset();if("textarea"!==a.type)return f.top+=a.offsetHeight,f;c=j(d);d=a.selectionStart;c.html(i.escapeHtml(a.value.substring(0,d-1))+"<span>x</span>");c.offset(f);f=c.last();a=f.offset();a.top+=f.height();0<d&&(a.left+=f.width());a.top-=b;a.left-=e;return a}});
KISSY.add("combobox/multi-value-combobox",["./cursor","./control"],function(i,h){function j(a,c){return c&&-1!==a.indexOf(c)}function k(a){a.newVal&&a.target===this.get("menu")&&this.alignWithCursor()}function c(d){var c=d.get("input"),g=d.get("value"),b=[],e=[],h=d.get("literal"),k=d.get("separator"),d=d.get("separatorType"),i=!1,p=d!==a,c=c.prop("selectionStart"),m,l,r=-1;for(m=0;m<g.length;m++)(l=g.charAt(m),h&&l===h&&(i=!i),i)?e.push(l):(m===c&&(r=b.length),p&&f.test(l))?(e.length&&b.push(e.join("")),
e=[],e.push(l)):j(k,l)?d===a?(e.push(l),e.length&&b.push(e.join("")),e=[]):(e.length&&b.push(e.join("")),e=[],e.push(l)):e.push(l);e.length&&b.push(e.join(""));b.length||b.push("");-1===r&&(d===a&&j(k,l)&&b.push(""),r=b.length-1);return{tokens:b,cursorPosition:c,tokenIndex:r}}var a="suffix",f=/\s|\xa0/,g=h("./cursor");return h("./control").extend({syncUI:function(){var a;this.get("alignWithCursor")&&(a=this.get("menu"),a.setInternal("align",null),a.on("beforeVisibleChange",k,this))},getValueForAutocomplete:function(){var d=
c(this),f=d.tokens,g=d.tokenIndex,d=this.get("separator"),b=this.get("separatorType"),f=f[g],g=f.length-1;if(b!==a)if(j(d,f.charAt(0)))f=f.slice(1);else return;else b===a&&j(d,f.charAt(g))&&(f=f.slice(0,g));return f},setValueFromAutocomplete:function(d,g){var h=this.get("input"),b=c(this),e=b.tokens,b=Math.max(0,b.tokenIndex),k=this.get("separator"),i;i=this.get("separatorType");var q=e[b+1]||"",p=e[b];if(i!==a){if(e[b]=p.charAt(0)+d,d&&(!q||!f.test(q.charAt(0))))e[b]+=" "}else e[b]=d,i=p.length-
1,j(k,p.charAt(i))?e[b]+=p.charAt(i):1===k.length&&(e[b]+=k);b=e.slice(0,b+1).join("").length;this.set("value",e.join(""),g);h.prop("selectionStart",b);h.prop("selectionEnd",b)},alignWithCursor:function(){var a=this.get("menu"),c;c=this.get("input");c=g(c);a.move(c.left,c.top)}},{ATTRS:{separator:{value:",;"},separatorType:{value:a},literal:{value:'"'},alignWithCursor:{}},xclass:"multi-value-combobox"})});
KISSY.add("combobox/filter-select",["./control"],function(i,h,j,k){i=h("./control");k.exports=i.extend({validate:function(c){var a=this;a.callSuper(function(f,g){f?c(f,g):a.get("dataSource").fetchData(g,function(d){a:{if(d=a.normalizeData(d))for(var f=0;f<d.length;f++)if(d[f].textContent===g){d=d[f];break a}d=!1}c(d?"":a.get("invalidMessage"),g,d)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}})});
KISSY.add("combobox/local-data-source",["attribute"],function(i,h){return h("attribute").extend({fetchData:function(j,k,c){var a=this.get("parse"),f=this.get("data"),f=a(j,f);k.call(c,f)}},{ATTRS:{data:{value:[]},parse:{value:function(j,k){var c=[],a=0;if(!j)return k;i.each(k,function(f){-1!==f.indexOf(j)&&c.push(f);a++});return c}}}})});
KISSY.add("combobox/remote-data-source",["io","attribute"],function(i,h){var j=h("io");return h("attribute").extend({fetchData:function(k,c,a){var f=this,g,d=f.get("paramName"),h=f.get("parse"),i=f.get("cache"),b=f.get("allowEmpty");f.caches=f.caches||{};f.io&&(f.io.abort(),f.io=null);if(!k&&!0!==b)return c.call(a,[]);if(i&&(g=f.caches[k]))return c.call(a,g);g=f.get("xhrCfg");g.data=g.data||{};g.data[d]=k;g.success=function(b){h&&(b=h(k,b));f.setInternal("data",b);i&&(f.caches[k]=b);c.call(a,b)};
f.io=j(g)}},{ATTRS:{paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}}})});
KISSY.add("combobox",["combobox/control","combobox/multi-value-combobox","combobox/filter-select","combobox/local-data-source","combobox/remote-data-source"],function(i,h){var j=h("combobox/control"),k=h("combobox/multi-value-combobox"),c=h("combobox/filter-select"),a=h("combobox/local-data-source"),f=h("combobox/remote-data-source");j.LocalDataSource=a;j.RemoteDataSource=f;j.FilterSelect=c;j.MultiValueComboBox=k;return j});
